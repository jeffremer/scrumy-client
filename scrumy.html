<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>scrumy.rb</title>
  <link rel="stylesheet" href="http://github.com/jashkenas/docco/raw/0.3.0/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="resources.html">resources.rb</a>
          <a class="source" href="scrumy.html">scrumy.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>scrumy.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p><strong>Scrumy Client</strong> is a Ruby REST client wrapper for <a href="http://apidoc.scrumy.com">Scrumy</a>.</p>

<p>Scrumy Client provides a simple client interface for retrieving Sprints, Stories,
Tasks, and Scrumers, as well as some tools for generating useful information with
those objects.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>The <a href="https://github.com/jeffremer/scrumy-client">source code</a> is available on Github.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Dependencies'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Dependencies">&#182;</a>
        </div>
        <h1>Dependencies</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>We need JSON</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>JSON responses are parsed and turned into the core Scrumy objects, key value
pairs in the JSON hashes become instance variables in the objects.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;json&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Scrumy Client uses <a href="https://github.com/archiloque/rest-client">rest-client</a>
for conveniently retrieving REST resources and handling some of the HTTP at a
higher level.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rest_client&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>We use <a href="http://as.rubyonrails.org/classes/Inflector.html">ActiveSupport::Inflector</a> to do
some of the metaprogramming magic and instantiate classes and create methods dynamically.
<code>Inflector</code> helps to pluralize, singularize, (de)modularize symbols.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;active_support/inflector&#39;</span>

<span class="k">module</span> <span class="nn">Scrumy</span>
  <span class="k">class</span> <span class="nc">Client</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Every client request sets the <code>@url</code> instance variable for easy debugging
Just call client.url to see that last requested URL.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">attr_reader</span> <span class="ss">:url</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p><code>Scrumy::Clients</code> are initialized with a project name and password.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
      <span class="vi">@project</span><span class="p">,</span> <span class="vi">@password</span> <span class="o">=</span> <span class="n">project</span><span class="p">,</span> <span class="n">password</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>This is the heart of the <code>Scrumy::Client</code> object.  It provides Ghost Methods via the Ruby
chainsaw, <code>method_missing</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    
    <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Figure out what kind of resource we&rsquo;re trying to get.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">klass</span> <span class="o">=</span> <span class="no">Scrumy</span><span class="o">::</span><span class="no">Models</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="nb">id</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">capitalize</span><span class="o">.</span><span class="n">singularize</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Special case for handling id=:current &ndash; this really only applies to Sprint resources
but if other resources specified the <code>current</code> sub-resources then it should still work.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="n">klass</span><span class="o">.</span><span class="n">current_url</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span><span class="o">==</span><span class="ss">:current</span>
        <span class="vi">@url</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">current_url</span><span class="p">,</span> <span class="ss">:current</span><span class="p">)</span>
      <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>TODO Figure out a better way of determining if the resource is singular or plural
The only argument that resources ever take is an ID, so pass the first arg as the ID.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="vi">@url</span> <span class="o">=</span> <span class="nb">format</span><span class="p">((</span><span class="nb">id</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/s$/</span> <span class="p">?</span> <span class="n">klass</span><span class="o">.</span><span class="n">list_url</span> <span class="p">:</span> <span class="n">klass</span><span class="o">.</span><span class="n">show_url</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Here we request the resource using the singular of the resource name as the root
to extract from the returned JSON hash.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">response</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="vi">@url</span><span class="p">,</span> <span class="nb">id</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">singularize</span><span class="p">)</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Responses are of two types, either arrays of hashes or a single hash</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">kind_of?</span> <span class="nb">Array</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>If it&rsquo;s array collect a new array by constructing objects based on the resource
name capitalized and singularized.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">response</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">obj</span><span class="o">|</span>          
          <span class="n">klass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Otherwise create a single new object of the correct type.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="n">klass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>TODO This grammar should be better
Currently subresources specify special sybmols in their name,
either :project to get @project off the client, or :id to get
the argument passed to the client.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
      <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;:project&#39;</span><span class="p">,</span> <span class="vi">@project</span><span class="p">)</span>
      <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;:id&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span> <span class="k">if</span> <span class="nb">id</span>
      <span class="n">url</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Early implementation to get snapshots, no model for this yet &ndash;
it just returns a <code>Hash</code> from the <code>JSON Array</code>.
def snapshots(id=:current)
  sprint_id = sprint(id.to_s)[&lsquo;id&rsquo;]
  @url = &ldquo;https://scrumy.com/api/sprints/#{sprint_id}/snapshots.json&rdquo;
  get(@url, nil)
end</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    
    <span class="kp">protected</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p><code>#get</code> provides the nuts and bolts for retrieving resources.  Give it a
resource URL and a root key and it will return either an array of hashes
at that root key or a single hash with values found at that key.</p>

<p>For example if the resource returns <code>{"foo"=&gt;{"id"=&gt;1, "bar"=&gt;"baz"}}</code>
then <code>#get(some_url, "foo")</code> will return the value of <code>"foo"</code> from the hash:
<code>{"id"=&gt;1, "bar"=&gt;"baz"}</code>.  This is important because later on in the models
we assign all the values in the latter hash as instance variables on the
model objects.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="k">begin</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Start by creating a new <code>RestCLient::Resource</code> authenticated with
the <code>@project</code> name and <code>@password</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">resource</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">::</span><span class="no">Resource</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="vi">@project</span><span class="p">,</span> <span class="vi">@password</span><span class="p">)</span>
          </pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p><code>GET</code> the resource</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">resource</span><span class="o">.</span><span class="n">get</span> <span class="p">{</span><span class="o">|</span><span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
            <span class="k">case</span> <span class="n">response</span><span class="o">.</span><span class="n">code</span>
            <span class="k">when</span> <span class="mi">200</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>and on success parse the response</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>If it&rsquo;s <code>Array</code> then collect the hashes and flatten them on the <code>root</code> key.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="k">if</span> <span class="n">json</span><span class="o">.</span><span class="n">kind_of?</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">root</span>
                <span class="n">json</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">item</span><span class="o">|</span> 
                  <span class="n">item</span><span class="o">[</span><span class="n">root</span><span class="o">]</span>
                <span class="p">}</span>
              <span class="k">else</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Otherwise just return the <code>Hash</code> at the root or the JSON itself directly.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>                <span class="n">root</span> <span class="p">?</span> <span class="n">json</span><span class="o">[</span><span class="n">root</span><span class="o">]</span> <span class="p">:</span> <span class="n">json</span>
              <span class="k">end</span>
            <span class="k">else</span>
              <span class="n">response</span><span class="o">.</span><span class="n">return!</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="p">}</span>
        <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Rescue and reraise with the current <code>@url</code> for debugging purposes</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">raise</span> <span class="s2">&quot;Problem fetching </span><span class="si">#{</span><span class="vi">@url</span><span class="si">}</span><span class="s2"> because </span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>
  
  <span class="k">end</span>
  </pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>This is the abstract <code>Scrumy::Model</code> class that all resource models inherit from.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">module</span> <span class="nn">Models</span>
    <span class="k">class</span> <span class="nc">Model</span>
      <span class="kp">attr_reader</span> <span class="ss">:id</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>When passed a hash the constructor will initialize the object with instance variables
named after the keys in the hash.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
        <span class="vi">@client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="n">args</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
          <span class="nb">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">unless</span> <span class="n">v</span><span class="o">.</span><span class="n">nil?</span>
        <span class="k">end</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>This method missing provides a Ghost Method proxy to access or mutate any instance variable.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="o">/=</span><span class="vg">$/</span>
          <span class="nb">id</span> <span class="o">=</span> <span class="nb">id</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/=$/</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>        
          <span class="nb">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>Adapter methods for the resource DSL, this provides the
show, list, and current sub-resource defition methods.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>For each :show, :list, :current</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="o">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:list</span><span class="p">,</span> <span class="ss">:current</span><span class="o">].</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="nb">method</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>Create a method that sets a class instance variable to the URL argument</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nb">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="nb">method</span> <span class="k">do</span> <span class="o">|</span><span class="n">url</span><span class="o">|</span>
            <span class="nb">instance_variable_set</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="nb">method</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">_url&quot;</span><span class="p">,</span> <span class="n">url</span>
          <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>And create an accessor for that URL.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nb">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">method</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">_url&quot;</span><span class="o">.</span><span class="n">to_sym</span> <span class="k">do</span>
            <span class="nb">instance_variable_get</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="nb">method</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">_url&quot;</span>
          <span class="k">end</span>
        <span class="p">}</span>
      <span class="k">end</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>Only current Sprints are complete, so other models need to know how ot lazily load their
children.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>Specifying a lazy_load key in a subclass defines a new instance method on that class
that uses the client to fetch the right resource and set the appropriate instance variable
correctly.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">lazy_load</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
        <span class="n">define_method</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">client</span> <span class="o">=</span> <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@client&quot;</span><span class="p">)</span>
          <span class="n">ivar</span> <span class="o">=</span> <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="n">clss</span> <span class="o">=</span> <span class="no">Models</span><span class="o">.</span><span class="n">send</span> <span class="ss">:const_get</span><span class="p">,</span> <span class="nb">method</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">singularize</span><span class="o">.</span><span class="n">classify</span>
          <span class="n">root</span> <span class="o">=</span> <span class="nb">method</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">singularize</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>First check if the instance variable is already set, but perhaps incorrectly as a Hash
If so, then instantiate the instance variable as the correct type.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">if</span> <span class="n">ivar</span><span class="o">.</span><span class="n">kind_of?</span> <span class="nb">Array</span>
            <span class="n">ivar</span><span class="o">.</span><span class="n">collect!</span><span class="p">{</span><span class="o">|</span><span class="n">single</span><span class="o">|</span> <span class="n">clss</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">single</span><span class="o">[</span><span class="n">root</span><span class="o">]</span><span class="p">,</span> <span class="n">client</span><span class="p">)}</span> <span class="k">if</span> <span class="n">ivar</span> <span class="ow">and</span> <span class="n">ivar</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">kind_of?</span><span class="no">Hash</span>
          <span class="k">elsif</span> <span class="n">ivar</span> 
            <span class="n">ivar</span> <span class="o">=</span> <span class="n">clss</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>
          <span class="k">end</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>Return if already set, sort of minimal caching.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">return</span> <span class="n">ivar</span> <span class="k">if</span> <span class="n">ivar</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>Last resort, fetch from the rest client.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">ivar</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@id&quot;</span><span class="p">))</span>
        <span class="p">}</span>
      <span class="k">end</span>
    
      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">helper</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="nb">name</span> <span class="k">do</span>
          <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
 </pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>This is entry point for the DSL that specifies resources</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">def</span> <span class="nf">resource</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>It creates a new class based on the resource name scoped tot he Scrumy module</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">klass</span> <span class="o">=</span> <span class="no">Scrumy</span><span class="o">::</span><span class="no">Models</span><span class="o">.</span><span class="n">const_set</span><span class="p">(</span><span class="nb">name</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">classify</span><span class="p">,</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Scrumy</span><span class="o">::</span><span class="no">Models</span><span class="o">::</span><span class="no">Model</span><span class="p">))</span></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>Then executes the block on the class.  The class provides several class
methods for making instances behave correctly.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">klass</span><span class="o">.</span><span class="n">class_exec</span> <span class="o">&amp;</span><span class="n">block</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>Loads in the default resources, see <code>resources.rb</code></p>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">load</span><span class="p">(</span><span class="s1">&#39;resources.rb&#39;</span><span class="p">)</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
